{"ast":null,"code":"import * as i0 from \"@angular/core\";\nimport * as i1 from \"src/app/adapters/purchase.repository.adapter\";\nimport * as i2 from \"@angular/router\";\nimport * as i3 from \"src/services/auth.service\";\nimport * as i4 from \"@angular/common\";\nfunction CartComponent_div_3_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 4);\n    i0.ɵɵtext(1, \"Cargando carrito...\");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction CartComponent_div_4_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 5);\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r1 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(1);\n    i0.ɵɵtextInterpolate1(\" \", ctx_r1.error, \" \");\n  }\n}\nfunction CartComponent_div_5_div_1_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 9)(1, \"p\");\n    i0.ɵɵtext(2, \"El carrito est\\u00E1 vac\\u00EDo.\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(3, \"a\", 10);\n    i0.ɵɵtext(4, \"Continuar comprando\");\n    i0.ɵɵelementEnd()();\n  }\n}\nfunction CartComponent_div_5_div_2_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r8 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"div\", 11);\n    i0.ɵɵelement(1, \"img\", 12);\n    i0.ɵɵelementStart(2, \"div\", 13)(3, \"h3\");\n    i0.ɵɵtext(4);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(5, \"p\", 14);\n    i0.ɵɵtext(6);\n    i0.ɵɵpipe(7, \"currency\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(8, \"p\");\n    i0.ɵɵtext(9);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(10, \"button\", 15);\n    i0.ɵɵlistener(\"click\", function CartComponent_div_5_div_2_Template_button_click_10_listener() {\n      const restoredCtx = i0.ɵɵrestoreView(_r8);\n      const item_r6 = restoredCtx.$implicit;\n      const ctx_r7 = i0.ɵɵnextContext(2);\n      return i0.ɵɵresetView(ctx_r7.removeFromCart(item_r6));\n    });\n    i0.ɵɵelementStart(11, \"span\", 16);\n    i0.ɵɵtext(12, \"\\u00D7\");\n    i0.ɵɵelementEnd()()();\n  }\n  if (rf & 2) {\n    const item_r6 = ctx.$implicit;\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"src\", item_r6.urlImage, i0.ɵɵsanitizeUrl)(\"alt\", item_r6.name);\n    i0.ɵɵadvance(3);\n    i0.ɵɵtextInterpolate(item_r6.name);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(i0.ɵɵpipeBind4(7, 5, item_r6.price, \"MXN\", \"symbol\", \"1.2-2\"));\n    i0.ɵɵadvance(3);\n    i0.ɵɵtextInterpolate1(\"Descripci\\u00F3n: \", item_r6.description, \"\");\n  }\n}\nfunction CartComponent_div_5_div_3_ng_container_4_p_6_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"p\", 22);\n    i0.ɵɵtext(1, \" Fondos insuficientes para completar la compra. \");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction CartComponent_div_5_div_3_ng_container_4_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r14 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementContainerStart(0);\n    i0.ɵɵelementStart(1, \"p\");\n    i0.ɵɵtext(2);\n    i0.ɵɵpipe(3, \"currency\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(4, \"button\", 20);\n    i0.ɵɵlistener(\"click\", function CartComponent_div_5_div_3_ng_container_4_Template_button_click_4_listener() {\n      i0.ɵɵrestoreView(_r14);\n      const ctx_r13 = i0.ɵɵnextContext(3);\n      return i0.ɵɵresetView(ctx_r13.processOrder());\n    });\n    i0.ɵɵtext(5);\n    i0.ɵɵelementEnd();\n    i0.ɵɵtemplate(6, CartComponent_div_5_div_3_ng_container_4_p_6_Template, 2, 0, \"p\", 21);\n    i0.ɵɵelementContainerEnd();\n  }\n  if (rf & 2) {\n    const ctx_r9 = i0.ɵɵnextContext(3);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate1(\"Fondos disponibles: \", i0.ɵɵpipeBind4(3, 5, ctx_r9.getUserFunds(), \"MXN\", \"symbol\", \"1.2-2\"), \"\");\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"disabled\", ctx_r9.loading || !ctx_r9.hasSufficientFunds())(\"title\", !ctx_r9.hasSufficientFunds() ? \"Fondos insuficientes\" : \"\");\n    i0.ɵɵadvance(1);\n    i0.ɵɵtextInterpolate1(\" \", ctx_r9.loading ? \"Procesando...\" : \"Proceder al pago\", \" \");\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"ngIf\", !ctx_r9.hasSufficientFunds());\n  }\n}\nfunction CartComponent_div_5_div_3_ng_template_5_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r16 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"p\", 23);\n    i0.ɵɵtext(1, \" Debes iniciar sesi\\u00F3n para realizar la compra. \");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(2, \"button\", 24);\n    i0.ɵɵlistener(\"click\", function CartComponent_div_5_div_3_ng_template_5_Template_button_click_2_listener() {\n      i0.ɵɵrestoreView(_r16);\n      const ctx_r15 = i0.ɵɵnextContext(3);\n      return i0.ɵɵresetView(ctx_r15.login());\n    });\n    i0.ɵɵtext(3, \" Iniciar sesi\\u00F3n para comprar \");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction CartComponent_div_5_div_3_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 17)(1, \"h3\");\n    i0.ɵɵtext(2);\n    i0.ɵɵpipe(3, \"currency\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtemplate(4, CartComponent_div_5_div_3_ng_container_4_Template, 7, 10, \"ng-container\", 18);\n    i0.ɵɵtemplate(5, CartComponent_div_5_div_3_ng_template_5_Template, 4, 0, \"ng-template\", null, 19, i0.ɵɵtemplateRefExtractor);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const _r10 = i0.ɵɵreference(6);\n    const ctx_r5 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate1(\"Total: \", i0.ɵɵpipeBind4(3, 3, ctx_r5.getTotal(), \"MXN\", \"symbol\", \"1.2-2\"), \"\");\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"ngIf\", ctx_r5.isLoggedIn)(\"ngIfElse\", _r10);\n  }\n}\nfunction CartComponent_div_5_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\");\n    i0.ɵɵtemplate(1, CartComponent_div_5_div_1_Template, 5, 0, \"div\", 6);\n    i0.ɵɵtemplate(2, CartComponent_div_5_div_2_Template, 13, 10, \"div\", 7);\n    i0.ɵɵtemplate(3, CartComponent_div_5_div_3_Template, 7, 8, \"div\", 8);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"ngIf\", ctx_r2.cartItems.length === 0);\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"ngForOf\", ctx_r2.cartItems);\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"ngIf\", ctx_r2.cartItems.length > 0);\n  }\n}\nexport class CartComponent {\n  constructor(purchaseService, router, authService) {\n    this.purchaseService = purchaseService;\n    this.router = router;\n    this.authService = authService;\n    this.cartItems = [];\n    this.loading = false;\n    this.error = null;\n    this.isLoggedIn = false;\n  }\n  ngOnInit() {\n    this.loadCartFromLocalStorage();\n    this.authSubscription = this.authService.isLoggedIn$.subscribe(isLoggedIn => {\n      this.isLoggedIn = isLoggedIn;\n      console.log('CartComponent - Estado de inicio de sesión actualizado:', isLoggedIn);\n    });\n  }\n  ngOnDestroy() {\n    if (this.authSubscription) {\n      this.authSubscription.unsubscribe();\n    }\n  }\n  loadCartFromLocalStorage() {\n    this.loading = true;\n    try {\n      const cartData = localStorage.getItem('cart');\n      if (cartData) {\n        this.cartItems = JSON.parse(cartData);\n      }\n      this.loading = false;\n    } catch (e) {\n      this.error = 'Error al cargar el carrito';\n      this.loading = false;\n    }\n  }\n  saveCartToLocalStorage() {\n    try {\n      localStorage.setItem('cart', JSON.stringify(this.cartItems));\n    } catch (e) {\n      this.error = 'Error al guardar el carrito';\n    }\n  }\n  addToCart(product) {\n    this.cartItems.push(product);\n    this.saveCartToLocalStorage();\n  }\n  removeFromCart(product) {\n    const index = this.cartItems.findIndex(item => item.idProduct === product.idProduct);\n    if (index > -1) {\n      this.cartItems.splice(index, 1);\n      this.saveCartToLocalStorage();\n    }\n  }\n  getTotal() {\n    return this.cartItems.reduce((total, item) => total + this.parsePrice(item.price), 0);\n  }\n  parsePrice(price) {\n    if (typeof price === 'number') {\n      return price;\n    }\n    if (typeof price === 'string') {\n      const cleanedPrice = price.replace(/[^\\d.-]/g, '');\n      const parsedPrice = parseFloat(cleanedPrice);\n      return isNaN(parsedPrice) ? 0 : parsedPrice;\n    }\n    return 0;\n  }\n  processOrder() {\n    if (!this.isLoggedIn) {\n      this.router.navigate(['/login']);\n      return;\n    }\n    this.loading = true;\n    this.error = null;\n    const userId = this.authService.getUserId();\n    if (userId === null) {\n      this.error = 'Error al obtener la información del usuario';\n      this.loading = false;\n      return;\n    }\n    const total = this.getTotal();\n    this.purchaseService.processOrder(userId, this.cartItems, total).subscribe(purchase => {\n      this.loading = false;\n      this.cartItems = [];\n      this.saveCartToLocalStorage();\n      alert('¡Orden procesada con éxito!');\n    }, error => {\n      this.loading = false;\n      this.error = error.message || 'Error al procesar la orden';\n    });\n  }\n  getUserFunds() {\n    return this.authService.getUserFunds();\n  }\n  hasSufficientFunds() {\n    const userFunds = this.getUserFunds();\n    const total = this.getTotal();\n    return userFunds >= total;\n  }\n  login() {\n    this.router.navigate(['/login']);\n  }\n  static #_ = this.ɵfac = function CartComponent_Factory(t) {\n    return new (t || CartComponent)(i0.ɵɵdirectiveInject(i1.PurchaseService), i0.ɵɵdirectiveInject(i2.Router), i0.ɵɵdirectiveInject(i3.AuthService));\n  };\n  static #_2 = this.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n    type: CartComponent,\n    selectors: [[\"app-cart\"]],\n    decls: 6,\n    vars: 3,\n    consts: [[1, \"cart-container\"], [\"class\", \"loading\", 4, \"ngIf\"], [\"class\", \"error-message\", 4, \"ngIf\"], [4, \"ngIf\"], [1, \"loading\"], [1, \"error-message\"], [\"class\", \"empty-cart\", 4, \"ngIf\"], [\"class\", \"cart-item\", 4, \"ngFor\", \"ngForOf\"], [\"class\", \"cart-total\", 4, \"ngIf\"], [1, \"empty-cart\"], [\"routerLink\", \"/products\", 1, \"continue-shopping\"], [1, \"cart-item\"], [1, \"cart-item-image\", 3, \"src\", \"alt\"], [1, \"cart-item-details\"], [1, \"item-price\"], [\"title\", \"Eliminar producto\", 1, \"remove-button\", 3, \"click\"], [1, \"remove-icon\"], [1, \"cart-total\"], [4, \"ngIf\", \"ngIfElse\"], [\"loginMessage\", \"\"], [1, \"checkout-button\", 3, \"disabled\", \"title\", \"click\"], [\"class\", \"insufficient-funds\", 4, \"ngIf\"], [1, \"insufficient-funds\"], [1, \"login-message\"], [1, \"checkout-button\", 3, \"click\"]],\n    template: function CartComponent_Template(rf, ctx) {\n      if (rf & 1) {\n        i0.ɵɵelementStart(0, \"div\", 0)(1, \"h2\");\n        i0.ɵɵtext(2, \"Carrito de Compras\");\n        i0.ɵɵelementEnd();\n        i0.ɵɵtemplate(3, CartComponent_div_3_Template, 2, 0, \"div\", 1);\n        i0.ɵɵtemplate(4, CartComponent_div_4_Template, 2, 1, \"div\", 2);\n        i0.ɵɵtemplate(5, CartComponent_div_5_Template, 4, 3, \"div\", 3);\n        i0.ɵɵelementEnd();\n      }\n      if (rf & 2) {\n        i0.ɵɵadvance(3);\n        i0.ɵɵproperty(\"ngIf\", ctx.loading);\n        i0.ɵɵadvance(1);\n        i0.ɵɵproperty(\"ngIf\", ctx.error);\n        i0.ɵɵadvance(1);\n        i0.ɵɵproperty(\"ngIf\", !ctx.loading && !ctx.error);\n      }\n    },\n    dependencies: [i4.NgForOf, i4.NgIf, i2.RouterLink, i4.CurrencyPipe],\n    encapsulation: 2\n  });\n}","map":{"version":3,"mappings":"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","names":["i0","CartComponent","constructor","purchaseService","router","authService","ngOnInit","loadCartFromLocalStorage","authSubscription","isLoggedIn$","subscribe","isLoggedIn","console","log","ngOnDestroy","unsubscribe","loading","cartData","localStorage","getItem","cartItems","JSON","parse","e","error","saveCartToLocalStorage","setItem","stringify","addToCart","product","push","removeFromCart","index","findIndex","item","idProduct","splice","getTotal","reduce","total","parsePrice","price","cleanedPrice","replace","parsedPrice","parseFloat","isNaN","processOrder","navigate","userId","getUserId","purchase","alert","message","getUserFunds","hasSufficientFunds","userFunds","login","selectors","decls","vars","consts","template"],"sourceRoot":"","sources":["C:\\Users\\cruza\\Ecommerce Front\\src\\components\\cart\\cart.component.html","C:\\Users\\cruza\\Ecommerce Front\\src\\components\\cart\\cart.component.ts"],"sourcesContent":["<div class=\"cart-container\">\r\n    <h2>Carrito de Compras</h2>\r\n    \r\n    <div *ngIf=\"loading\" class=\"loading\">Cargando carrito...</div>\r\n  \r\n    <div *ngIf=\"error\" class=\"error-message\">\r\n      {{ error }}\r\n    </div>\r\n  \r\n    <div *ngIf=\"!loading && !error\">\r\n      <div *ngIf=\"cartItems.length === 0\" class=\"empty-cart\">\r\n        <p>El carrito está vacío.</p>\r\n        <a routerLink=\"/products\" class=\"continue-shopping\">Continuar comprando</a>\r\n      </div>\r\n      <div *ngFor=\"let item of cartItems\" class=\"cart-item\">\r\n        <img [src]=\"item.urlImage\" [alt]=\"item.name\" class=\"cart-item-image\">\r\n        <div class=\"cart-item-details\">\r\n          <h3>{{ item.name }}</h3>\r\n          <p class=\"item-price\">{{ (item.price) | currency:'MXN':'symbol':'1.2-2' }}</p>\r\n          <p>Descripción: {{ item.description }}</p>\r\n        </div>\r\n        <button (click)=\"removeFromCart(item)\" class=\"remove-button\" title=\"Eliminar producto\">\r\n          <span class=\"remove-icon\">×</span>\r\n        </button>\r\n      </div>\r\n      <div *ngIf=\"cartItems.length > 0\" class=\"cart-total\">\r\n        <h3>Total: {{ getTotal() | currency:'MXN':'symbol':'1.2-2' }}</h3>\r\n        <ng-container *ngIf=\"isLoggedIn; else loginMessage\">\r\n          <p>Fondos disponibles: {{ getUserFunds() | currency:'MXN':'symbol':'1.2-2' }}</p>\r\n          <button \r\n            (click)=\"processOrder()\" \r\n            class=\"checkout-button\" \r\n            [disabled]=\"loading || !hasSufficientFunds()\"\r\n            [title]=\"!hasSufficientFunds() ? 'Fondos insuficientes' : ''\"\r\n          >\r\n            {{ loading ? 'Procesando...' : 'Proceder al pago' }}\r\n          </button>\r\n          <p *ngIf=\"!hasSufficientFunds()\" class=\"insufficient-funds\">\r\n            Fondos insuficientes para completar la compra.\r\n          </p>\r\n        </ng-container>\r\n        <ng-template #loginMessage>\r\n          <p class=\"login-message\">\r\n            Debes iniciar sesión para realizar la compra.\r\n          </p>\r\n          <button (click)=\"login()\" class=\"checkout-button\">\r\n            Iniciar sesión para comprar\r\n          </button>\r\n        </ng-template>\r\n      </div>\r\n    </div>\r\n  </div>","import { Component, OnInit, OnDestroy } from '@angular/core';\r\nimport { Router } from '@angular/router';\r\nimport { Subscription } from 'rxjs';\r\nimport { PurchaseService } from 'src/app/adapters/purchase.repository.adapter';\r\nimport { Product } from 'src/app/model/product';\r\nimport { AuthService } from 'src/services/auth.service';\r\n\r\n@Component({\r\n  selector: 'app-cart',\r\n  templateUrl: './cart.component.html',\r\n})\r\nexport class CartComponent implements OnInit, OnDestroy {\r\n  cartItems: Product[] = [];\r\n  loading: boolean = false;\r\n  error: string | null = null;\r\n  isLoggedIn: boolean = false;\r\n  private authSubscription: Subscription | undefined;\r\n\r\n  constructor(\r\n    private purchaseService: PurchaseService,\r\n    private router: Router,\r\n    private authService: AuthService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.loadCartFromLocalStorage();\r\n    this.authSubscription = this.authService.isLoggedIn$.subscribe(\r\n      isLoggedIn => {\r\n        this.isLoggedIn = isLoggedIn;\r\n        console.log('CartComponent - Estado de inicio de sesión actualizado:', isLoggedIn);\r\n      }\r\n    );\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    if (this.authSubscription) {\r\n      this.authSubscription.unsubscribe();\r\n    }\r\n  }\r\n\r\n  loadCartFromLocalStorage() {\r\n    this.loading = true;\r\n    try {\r\n      const cartData = localStorage.getItem('cart');\r\n      if (cartData) {\r\n        this.cartItems = JSON.parse(cartData);\r\n      }\r\n      this.loading = false;\r\n    } catch (e) {\r\n      this.error = 'Error al cargar el carrito';\r\n      this.loading = false;\r\n    }\r\n  }\r\n\r\n  saveCartToLocalStorage() {\r\n    try {\r\n      localStorage.setItem('cart', JSON.stringify(this.cartItems));\r\n    } catch (e) {\r\n      this.error = 'Error al guardar el carrito';\r\n    }\r\n  }\r\n\r\n  addToCart(product: Product) {\r\n    this.cartItems.push(product);\r\n    this.saveCartToLocalStorage();\r\n  }\r\n\r\n  removeFromCart(product: Product) {\r\n    const index = this.cartItems.findIndex(item => item.idProduct === product.idProduct);\r\n    if (index > -1) {\r\n      this.cartItems.splice(index, 1);\r\n      this.saveCartToLocalStorage();\r\n    }\r\n  }\r\n\r\n  getTotal(): number {\r\n    return this.cartItems.reduce((total, item) => total + this.parsePrice(item.price), 0);\r\n  }\r\n\r\n  private parsePrice(price: unknown): number {\r\n    if (typeof price === 'number') {\r\n      return price;\r\n    }\r\n    if (typeof price === 'string') {\r\n      const cleanedPrice = price.replace(/[^\\d.-]/g, '');\r\n      const parsedPrice = parseFloat(cleanedPrice);\r\n      return isNaN(parsedPrice) ? 0 : parsedPrice;\r\n    }\r\n    return 0;\r\n  }\r\n\r\n  processOrder() {\r\n    if (!this.isLoggedIn) {\r\n      this.router.navigate(['/login']);\r\n      return;\r\n    }\r\n\r\n    this.loading = true;\r\n    this.error = null;\r\n    const userId = this.authService.getUserId();\r\n    if (userId === null) {\r\n      this.error = 'Error al obtener la información del usuario';\r\n      this.loading = false;\r\n      return;\r\n    }\r\n\r\n    const total = this.getTotal();\r\n\r\n    this.purchaseService.processOrder(userId, this.cartItems, total).subscribe(\r\n      (purchase) => {\r\n        this.loading = false;\r\n        this.cartItems = [];\r\n        this.saveCartToLocalStorage();\r\n        alert('¡Orden procesada con éxito!');\r\n      },\r\n      (error) => {\r\n        this.loading = false;\r\n        this.error = error.message || 'Error al procesar la orden';\r\n      }\r\n    );\r\n  }\r\n\r\n  getUserFunds(): number {\r\n    return this.authService.getUserFunds();\r\n  }\r\n\r\n  hasSufficientFunds(): boolean {\r\n    const userFunds = this.getUserFunds();\r\n    const total = this.getTotal();\r\n    return userFunds >= total;\r\n  }\r\n\r\n  login() {\r\n    this.router.navigate(['/login']);\r\n  }\r\n}"]},"metadata":{},"sourceType":"module","externalDependencies":[]}